{% extends "base.html" %}

{% block title %}{{ title|first }}{% endblock %}
{% block head %}
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2>Page Result</h1>
            <iframe 
                src="{{ link|safe }}"
                width="100%"
                height="100vh"
            > </iframe>
        </div>
    </div>
    <span class="end_of_show_page"
    >
        End of page
    </span>
</div>

<script>
    let wait = ms => new Promise((r, j)=>setTimeout(r, ms))
    $(document).ready(function(){
        var iframe = $('iframe');

        iframe.on('load', () => {
            var iframeBody = iframe.contents().find('body');
            iframeBody.find('a').each(function(){
                $(this).attr('target', '_blank');
            });

            wait(70).then(() => {
                showFeedback();
            });
            
        });
    });

    function showFeedback() {
        const feedback = window.confirm("Do you find the result is relevant?");
        
        if (feedback) {
            window.alert("Thank you for your feedback!, We glad to hear that you find the result is relevant.");
        } 
        else {
            window.alert("Thank you for your feedback!, We will try to improve our search engine.");
        }

        console.log("{{ q }}")
        let data = {
            'q': '{{ q }}',
            'feedback': feedback,
            'link': '{{ link }}',
            'title': '{{ title|first }}',
            'snippet': '{{ snippet|first }}',
            'displayLink': '{{ displayLink|first }}',
            // get the iframe body html
            // 'html': $('iframe').contents().find('body').html(),
        }
        console.log(data);

        $.ajax({
            url: '/feedback',
            type: 'POST',
            data: JSON.stringify(data),
            success: function(response) {
                console.log(response);
            },
            error: function(error) {
                console.log(error);

            }
        });
    }
</script>

{% endblock body %}
